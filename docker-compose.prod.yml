services:
  api:
    build:
      context: ./services
      dockerfile: api/Dockerfile
    environment:
      - DATABASE_URL=${DATABASE_URL}
      - SPOTIFY_CLIENT_ID=${SPOTIFY_CLIENT_ID}
      - SPOTIFY_CLIENT_SECRET=${SPOTIFY_CLIENT_SECRET}
      - SPOTIFY_REDIRECT_URI=${SPOTIFY_REDIRECT_URI}
      - TOKEN_ENCRYPTION_KEY=${TOKEN_ENCRYPTION_KEY}
      - ADMIN_AUTH_MODE=${ADMIN_AUTH_MODE:-token}
      - ADMIN_TOKEN=${ADMIN_TOKEN}
      - CORS_ALLOWED_ORIGINS=${CORS_ALLOWED_ORIGINS}
      - UPLOAD_DIR=/app/uploads
      - LOG_RETENTION_DAYS=${LOG_RETENTION_DAYS:-90}
      - RATE_LIMIT_AUTH_PER_MINUTE=${RATE_LIMIT_AUTH_PER_MINUTE:-10}
      - RATE_LIMIT_MCP_PER_MINUTE=${RATE_LIMIT_MCP_PER_MINUTE:-60}
    volumes:
      - upload_data:/app/uploads
    networks:
      - app_network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 512m
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/healthz"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    command:
      [
        "uvicorn", "app.main:app",
        "--host", "0.0.0.0",
        "--port", "8000",
        "--workers", "2",
        "--proxy-headers",
        "--forwarded-allow-ips", "*"
      ]
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

  collector:
    build:
      context: ./services
      dockerfile: collector/Dockerfile
    environment:
      - DATABASE_URL=${DATABASE_URL}
      - SPOTIFY_CLIENT_ID=${SPOTIFY_CLIENT_ID}
      - SPOTIFY_CLIENT_SECRET=${SPOTIFY_CLIENT_SECRET}
      - TOKEN_ENCRYPTION_KEY=${TOKEN_ENCRYPTION_KEY}
      - COLLECTOR_INTERVAL_SECONDS=${COLLECTOR_INTERVAL_SECONDS:-600}
      - INITIAL_SYNC_ENABLED=${INITIAL_SYNC_ENABLED:-true}
      - INITIAL_SYNC_MAX_DAYS=${INITIAL_SYNC_MAX_DAYS:-30}
      - INITIAL_SYNC_MAX_REQUESTS=${INITIAL_SYNC_MAX_REQUESTS:-200}
      - INITIAL_SYNC_CONCURRENCY=${INITIAL_SYNC_CONCURRENCY:-2}
      - IMPORT_MAX_ZIP_SIZE_MB=${IMPORT_MAX_ZIP_SIZE_MB:-500}
      - IMPORT_MAX_RECORDS=${IMPORT_MAX_RECORDS:-5000000}
      - UPLOAD_DIR=/app/uploads
    volumes:
      - upload_data:/app/uploads
    depends_on:
      api:
        condition: service_healthy
    networks:
      - app_network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 256m
    command: ["python", "-m", "collector.main"]
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

  frontend:
    build:
      context: ./services/frontend
      dockerfile: Dockerfile
    environment:
      - API_BASE_URL=http://api:8000
      - FRONTEND_AUTH_MODE=${FRONTEND_AUTH_MODE:-token}
      - ADMIN_TOKEN=${ADMIN_TOKEN}
    depends_on:
      api:
        condition: service_healthy
    networks:
      - app_network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 256m
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8001/healthz"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    command:
      [
        "uvicorn", "frontend.main:app",
        "--host", "0.0.0.0",
        "--port", "8001",
        "--workers", "2",
        "--proxy-headers",
        "--forwarded-allow-ips", "*"
      ]
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

  explorer:
    build:
      context: ./services/explorer
      dockerfile: Dockerfile
    environment:
      - API_BASE_URL=http://api:8000
      - API_PUBLIC_URL=https://${DOMAIN}
      - EXPLORER_BASE_URL=https://${DOMAIN}
    depends_on:
      api:
        condition: service_healthy
    networks:
      - app_network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 256m
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8002/healthz"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    command:
      [
        "uvicorn", "explorer.main:app",
        "--host", "0.0.0.0",
        "--port", "8002",
        "--workers", "2",
        "--proxy-headers",
        "--forwarded-allow-ips", "*"
      ]
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

  oauth2-proxy:
    image: quay.io/oauth2-proxy/oauth2-proxy:v7.14.2
    environment:
      OAUTH2_PROXY_PROVIDER: google
      OAUTH2_PROXY_CLIENT_ID: ${GOOGLE_OAUTH_CLIENT_ID}
      OAUTH2_PROXY_CLIENT_SECRET: ${GOOGLE_OAUTH_CLIENT_SECRET}
      OAUTH2_PROXY_COOKIE_SECRET: ${OAUTH2_PROXY_COOKIE_SECRET}
      OAUTH2_PROXY_COOKIE_SECURE: "true"
      OAUTH2_PROXY_COOKIE_HTTPONLY: "true"
      OAUTH2_PROXY_COOKIE_SAMESITE: lax
      OAUTH2_PROXY_COOKIE_NAME: _spotify_mcp_auth
      OAUTH2_PROXY_COOKIE_EXPIRE: 168h
      OAUTH2_PROXY_COOKIE_REFRESH: 1h
      OAUTH2_PROXY_COOKIE_DOMAINS: ${DOMAIN}
      OAUTH2_PROXY_REDIRECT_URL: https://${DOMAIN}/oauth2/callback
      OAUTH2_PROXY_HTTP_ADDRESS: 0.0.0.0:4180
      OAUTH2_PROXY_REVERSE_PROXY: "true"
      OAUTH2_PROXY_SET_XAUTHREQUEST: "true"
      OAUTH2_PROXY_AUTHENTICATED_EMAILS_FILE: /etc/oauth2-proxy/authenticated-emails.txt
      OAUTH2_PROXY_EMAIL_DOMAINS: "*"
      OAUTH2_PROXY_SKIP_PROVIDER_BUTTON: "true"
    volumes:
      - ./deploy/authenticated-emails.txt:/etc/oauth2-proxy/authenticated-emails.txt:ro
    networks:
      - app_network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 128m
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

  caddy:
    image: caddy:2-alpine
    environment:
      - DOMAIN=${DOMAIN}
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./deploy/Caddyfile:/etc/caddy/Caddyfile:ro
      - caddy_data:/data
      - caddy_config:/config
    depends_on:
      api:
        condition: service_healthy
      frontend:
        condition: service_healthy
      explorer:
        condition: service_healthy
      oauth2-proxy:
        condition: service_started
    networks:
      - app_network
    restart: unless-stopped
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

networks:
  app_network:
    driver: bridge

volumes:
  upload_data:
    driver: local
  caddy_data:
    driver: local
  caddy_config:
    driver: local
