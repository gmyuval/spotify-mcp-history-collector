{% extends "base.html" %}
{% block title %}Logs{% endblock %}
{% block content %}
<h2 class="mb-4">Logs</h2>

<!-- Filters -->
<form hx-get="/logs/partials/logs-table"
      hx-target="#logs-tbody"
      hx-swap="innerHTML"
      hx-trigger="change from:select, keyup changed delay:500ms from:input[name='q'], keyup changed delay:500ms from:input[name='user_id']"
      class="row g-2 mb-3">
  <div class="col-auto">
    <select name="service" class="form-select form-select-sm">
      <option value="">All services</option>
      <option value="api" {% if service == "api" %}selected{% endif %}>api</option>
      <option value="collector" {% if service == "collector" %}selected{% endif %}>collector</option>
    </select>
  </div>
  <div class="col-auto">
    <select name="level" class="form-select form-select-sm">
      <option value="">All levels</option>
      <option value="error" {% if level == "error" %}selected{% endif %}>error</option>
      <option value="warning" {% if level == "warning" %}selected{% endif %}>warning</option>
      <option value="info" {% if level == "info" %}selected{% endif %}>info</option>
      <option value="debug" {% if level == "debug" %}selected{% endif %}>debug</option>
    </select>
  </div>
  <div class="col-auto">
    <input type="text" name="user_id" class="form-control form-control-sm"
           placeholder="User ID" value="{{ user_id | default('') }}">
  </div>
  <div class="col-auto">
    <input type="search" name="q" class="form-control form-control-sm"
           placeholder="Search messages..." value="{{ q | default('') }}">
  </div>
  <div class="col-auto d-flex align-items-center">
    <div class="form-check">
      <input class="form-check-input" type="checkbox" id="auto-refresh">
      <label class="form-check-label" for="auto-refresh">Auto-refresh</label>
    </div>
  </div>
</form>

<div class="card">
  <div class="card-body p-0">
    <table class="table table-striped table-hover table-sm mb-0">
      <thead>
        <tr>
          <th>Time</th><th>Service</th><th>Level</th><th>Message</th>
          <th>User</th><th>Job</th>
        </tr>
      </thead>
      <tbody id="logs-tbody"
             hx-get="/logs/partials/logs-table"
             hx-trigger="every 5s [document.getElementById('auto-refresh') && document.getElementById('auto-refresh').checked]"
             hx-swap="innerHTML">
        {% include "partials/_logs_table.html" %}
      </tbody>
    </table>
  </div>
</div>

<div id="logs-pagination" class="mt-3">
  {% if total > limit %}
  {% with url="/logs/partials/logs-table", target="#logs-tbody" %}
  {% include "partials/_pagination.html" %}
  {% endwith %}
  {% endif %}
</div>

<!-- Purge -->
<div class="card mt-4">
  <div class="card-header"><strong>Maintenance</strong></div>
  <div class="card-body">
    <form hx-post="/logs/purge"
          hx-target="#purge-result"
          hx-swap="innerHTML"
          hx-confirm="Are you sure you want to purge old logs?"
          class="row g-2 align-items-end">
      <div class="col-auto">
        <label class="form-label">Purge logs older than</label>
        <input type="number" name="days" value="30" min="1" class="form-control form-control-sm" style="width: 100px;">
      </div>
      <div class="col-auto">
        <span class="form-text">days</span>
      </div>
      <div class="col-auto">
        <button type="submit" class="btn btn-danger btn-sm">Purge</button>
      </div>
    </form>
    <div id="purge-result" class="mt-2"></div>
  </div>
</div>
{% endblock %}
