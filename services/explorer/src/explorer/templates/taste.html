{% extends "base.html" %}
{% block title %}Taste Profile{% endblock %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
  <h2 class="mb-0">Your Taste Profile</h2>
  {% if data and data.profile and data.profile.version > 0 %}
  <div>
    <span class="badge bg-secondary me-2">v{{ data.profile.version }}</span>
    <small class="text-muted">Updated {{ data.profile.updated_at[:10] if data.profile.updated_at else "never" }}</small>
  </div>
  {% endif %}
</div>

{% if data and data.profile %}
{% set profile = data.profile.profile %}
{% set version = data.profile.version %}

{% if version == 0 %}
<!-- Empty profile state -->
<div class="card mb-4">
  <div class="card-body text-center py-5">
    <h5 class="text-muted mb-3">No taste profile yet</h5>
    <p class="text-muted mb-4">
      Your taste profile is built as you interact with your AI assistant, or you can set it up manually below.
    </p>
    <button class="btn btn-spotify" data-bs-toggle="collapse" data-bs-target="#addGenreForm">
      Add Your First Genre
    </button>
    <div class="collapse mt-3" id="addGenreForm">
      <form action="/taste/update" method="post" class="d-inline-flex gap-2">
        <input type="hidden" name="action" value="add">
        <input type="hidden" name="field" value="core_genres">
        <input type="text" name="value" class="form-control form-control-sm" placeholder="e.g. symphonic metal" style="width: 250px;" required>
        <button type="submit" class="btn btn-spotify btn-sm">Add</button>
      </form>
    </div>
  </div>
</div>

{% else %}
<!-- Profile content -->
<div class="row g-4 mb-4">
  <!-- Core Genres -->
  <div class="col-md-6">
    <div class="card">
      <div class="card-header d-flex justify-content-between align-items-center">
        <strong>Core Genres</strong>
        <button class="btn btn-outline-secondary btn-sm" data-bs-toggle="collapse" data-bs-target="#addGenreSection">+</button>
      </div>
      <div class="card-body">
        {% if profile.core_genres %}
        <div class="d-flex flex-wrap gap-2 mb-2">
          {% for genre in profile.core_genres %}
          <span class="taste-tag">
            {{ genre }}
            <form action="/taste/update" method="post" class="d-inline">
              <input type="hidden" name="action" value="remove">
              <input type="hidden" name="field" value="core_genres">
              <input type="hidden" name="value" value="{{ genre }}">
              <button type="submit" class="taste-tag-remove" title="Remove">&times;</button>
            </form>
          </span>
          {% endfor %}
        </div>
        {% else %}
        <p class="text-muted mb-2">No genres set</p>
        {% endif %}
        <div class="collapse" id="addGenreSection">
          <form action="/taste/update" method="post" class="d-flex gap-2 mt-2">
            <input type="hidden" name="action" value="add">
            <input type="hidden" name="field" value="core_genres">
            <input type="text" name="value" class="form-control form-control-sm" placeholder="Add genre..." required>
            <button type="submit" class="btn btn-spotify btn-sm">Add</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Avoid List -->
  <div class="col-md-6">
    <div class="card">
      <div class="card-header d-flex justify-content-between align-items-center">
        <strong>Avoid</strong>
        <button class="btn btn-outline-secondary btn-sm" data-bs-toggle="collapse" data-bs-target="#addAvoidSection">+</button>
      </div>
      <div class="card-body">
        {% if profile.avoid %}
        <div class="d-flex flex-wrap gap-2 mb-2">
          {% for item in profile.avoid %}
          <span class="taste-tag taste-tag-avoid">
            {{ item }}
            <form action="/taste/update" method="post" class="d-inline">
              <input type="hidden" name="action" value="remove">
              <input type="hidden" name="field" value="avoid">
              <input type="hidden" name="value" value="{{ item }}">
              <button type="submit" class="taste-tag-remove" title="Remove">&times;</button>
            </form>
          </span>
          {% endfor %}
        </div>
        {% else %}
        <p class="text-muted mb-2">No items to avoid</p>
        {% endif %}
        <div class="collapse" id="addAvoidSection">
          <form action="/taste/update" method="post" class="d-flex gap-2 mt-2">
            <input type="hidden" name="action" value="add">
            <input type="hidden" name="field" value="avoid">
            <input type="text" name="value" class="form-control form-control-sm" placeholder="Add avoid item..." required>
            <button type="submit" class="btn btn-spotify btn-sm">Add</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Energy Preferences -->
  <div class="col-md-6">
    <div class="card">
      <div class="card-header"><strong>Energy Preferences</strong></div>
      <div class="card-body">
        {% if profile.energy_preferences %}
        <table class="table table-borderless table-sm mb-0">
          {% for key, val in profile.energy_preferences.items() %}
          <tr>
            <td class="text-muted">{{ key }}</td>
            <td>{{ val }}</td>
          </tr>
          {% endfor %}
        </table>
        {% else %}
        <p class="text-muted mb-0">Not set</p>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Playlist Rules -->
  <div class="col-md-6">
    <div class="card">
      <div class="card-header"><strong>Playlist Rules</strong></div>
      <div class="card-body">
        {% if profile.playlist_rules %}
        <table class="table table-borderless table-sm mb-0">
          {% for key, val in profile.playlist_rules.items() %}
          <tr>
            <td class="text-muted">{{ key | replace("_", " ") | title }}</td>
            <td>{{ val }}</td>
          </tr>
          {% endfor %}
        </table>
        {% else %}
        <p class="text-muted mb-0">No rules set</p>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Other profile fields (catch-all) -->
  {% set known_fields = ["core_genres", "avoid", "energy_preferences", "playlist_rules"] %}
  {% set other_keys = [] %}
  {% for key in profile.keys() %}
    {% if key not in known_fields %}
      {% if other_keys.append(key) %}{% endif %}
    {% endif %}
  {% endfor %}
  {% if other_keys %}
  <div class="col-md-12">
    <div class="card">
      <div class="card-header"><strong>Other Preferences</strong></div>
      <div class="card-body">
        <table class="table table-borderless table-sm mb-0">
          {% for key in other_keys %}
          <tr>
            <td class="text-muted">{{ key | replace("_", " ") | title }}</td>
            <td>
              {% if profile[key] is string %}
                {{ profile[key] }}
              {% elif profile[key] is iterable and profile[key] is not mapping %}
                {{ profile[key] | join(", ") }}
              {% else %}
                <code>{{ profile[key] | tojson }}</code>
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </table>
      </div>
    </div>
  </div>
  {% endif %}
</div>

<!-- Clear Profile -->
<div class="mb-4">
  <button class="btn btn-outline-danger btn-sm" data-bs-toggle="modal" data-bs-target="#clearProfileModal">
    Clear Entire Profile
  </button>
</div>

<!-- Clear confirmation modal -->
<div class="modal fade" id="clearProfileModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Clear Taste Profile</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p>This will permanently delete your taste profile. Your AI assistant will start fresh next time.</p>
        <p class="text-muted">Preference event history will be preserved for reference.</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <form action="/taste/clear" method="post" class="d-inline">
          <button type="submit" class="btn btn-danger">Clear Profile</button>
        </form>
      </div>
    </div>
  </div>
</div>
{% endif %}

<!-- Preference Events -->
<div class="card">
  <div class="card-header"><strong>Preference Event History</strong></div>
  <div class="card-body p-0" id="events-container"
       hx-get="/taste/partials/events?limit=20&offset=0"
       hx-trigger="load"
       hx-swap="innerHTML">
    <p class="text-muted text-center py-4 mb-0">Loading events...</p>
  </div>
</div>

{% else %}
<p class="text-muted">Unable to load taste profile data.</p>
{% endif %}
{% endblock %}
