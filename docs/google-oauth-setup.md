# Google OAuth Authentication

All human access to the application is gated behind Google OAuth using
[oauth2-proxy](https://oauth2-proxy.github.io/oauth2-proxy/) as a sidecar
container. Caddy's `forward_auth` directive checks authentication before
forwarding requests.

## Architecture

```text
Browser → Caddy :443
  ├── /healthz         → api:8000 (no auth — monitoring)
  ├── /oauth2/*        → oauth2-proxy:4180 (login/callback/sign_out)
  ├── /mcp/*           → api:8000 (Bearer token only — ChatGPT)
  └── everything else  → forward_auth oauth2-proxy:4180
                          ├── 401 → redirect to Google login
                          └── 200 → copy X-Auth-Request-Email → backend
```

### Route Auth Matrix

| Route | Auth Method | Notes |
|-------|-------------|-------|
| `/healthz` | None | Open for monitoring |
| `/oauth2/*` | oauth2-proxy | Google login/callback/sign_out |
| `/mcp/*` | Bearer token | Admin token for ChatGPT/programmatic access |
| All other routes | Google OAuth | Cookie-based session via forward_auth |

## Setup (One-Time)

### 1. Create Google Cloud OAuth Credentials

1. Go to [Google Cloud Console](https://console.cloud.google.com/)
2. Create a project (e.g., "Spotify MCP Admin")
3. Navigate to **APIs & Services > OAuth consent screen**
   - User Type: External
   - App name: "Spotify MCP Admin"
   - Authorized domains: `yourdomain.com`
   - Scopes: `email`, `profile`, `openid` (defaults)
4. Navigate to **APIs & Services > Credentials**
   - Create OAuth 2.0 Client ID
   - Application type: Web application
   - Authorized redirect URI: `https://yourdomain.com/oauth2/callback`
5. Copy the Client ID and Client Secret

### 2. Configure on the Server

SSH to the droplet and update `.env.prod`:

```bash
ssh deploy@DROPLET_IP
cd /opt/spotify-mcp
nano .env.prod
```

Add/update these variables:

```bash
GOOGLE_OAUTH_CLIENT_ID=your_client_id_from_step_1
GOOGLE_OAUTH_CLIENT_SECRET=your_client_secret_from_step_1
OAUTH2_PROXY_COOKIE_SECRET=<auto-generated-by-provision-script>
```

### 3. Configure Email Whitelist

Edit `deploy/authenticated-emails.txt` on the server (one email per line):

```bash
nano /opt/spotify-mcp/deploy/authenticated-emails.txt
```

```
youremail@gmail.com
another-admin@gmail.com
```

### 4. Restart Services

```bash
docker compose --env-file .env.prod -f docker-compose.prod.yml up -d
```

## User Management

### Add a User

1. SSH to the droplet
2. Edit `/opt/spotify-mcp/deploy/authenticated-emails.txt`
3. Add the new email on a new line
4. Restart oauth2-proxy:
   ```bash
   docker compose --env-file .env.prod -f docker-compose.prod.yml restart oauth2-proxy
   ```

### Remove a User

1. Remove their email from `authenticated-emails.txt`
2. Restart oauth2-proxy
3. Their session cookie becomes invalid within 1 hour (the refresh interval)

## Session Security

| Setting | Value | Purpose |
|---------|-------|---------|
| `cookie_secure` | `true` | HTTPS only |
| `cookie_httponly` | `true` | No JavaScript access (XSS protection) |
| `cookie_samesite` | `lax` | CSRF protection |
| `cookie_expire` | `168h` (7 days) | Session lifetime |
| `cookie_refresh` | `1h` | Revalidate with Google hourly |

## Spotify OAuth Interaction

The Spotify OAuth flow works behind forward_auth because the Google
session cookie persists across the Spotify redirect:

1. User visits `/auth/login` → forward_auth passes (Google cookie valid)
2. API redirects to Spotify authorization
3. Spotify redirects back to `/auth/callback` → forward_auth passes (same cookie)

No changes to the Spotify OAuth code were needed.

## ChatGPT / MCP Access

The `/mcp/*` routes bypass Google OAuth and use Bearer token auth:

```bash
curl -H "Authorization: Bearer $ADMIN_TOKEN" \
  -H "Content-Type: application/json" \
  https://yourdomain.com/mcp/call \
  -d '{"tool": "history.taste_summary", "args": {"days": 90, "user_id": 1}}'
```

This allows ChatGPT Custom GPT Actions to authenticate without browser-based
OAuth. The `ADMIN_TOKEN` is stored as a GPT secret.

## Troubleshooting

### "403 Forbidden" after Google login

Your email is not in `deploy/authenticated-emails.txt`. Add it and restart
oauth2-proxy.

### oauth2-proxy won't start

Check that all three env vars are set in `.env.prod`:
- `GOOGLE_OAUTH_CLIENT_ID`
- `GOOGLE_OAUTH_CLIENT_SECRET`
- `OAUTH2_PROXY_COOKIE_SECRET`

```bash
docker compose --env-file .env.prod -f docker-compose.prod.yml logs oauth2-proxy
```

### Session expired

Sessions last 7 days. After expiry, users are redirected to Google login
automatically. The `OAUTH2_PROXY_COOKIE_SECRET` must remain the same across
deploys — if changed, all sessions are invalidated.
