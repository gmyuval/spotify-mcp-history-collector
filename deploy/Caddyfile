{$DOMAIN:localhost} {
    # Health check — always open (no auth)
    handle /healthz {
        reverse_proxy api:8000
    }

    # oauth2-proxy routes — handle natively (login, callback, sign_out)
    handle /oauth2/* {
        reverse_proxy oauth2-proxy:4180 {
            header_up X-Real-IP {remote_host}
            header_up X-Forwarded-Uri {uri}
        }
    }

    # MCP endpoints — Bearer token auth only, skip forward_auth
    # ChatGPT/programmatic clients cannot do browser-based OAuth
    handle /mcp/* {
        reverse_proxy api:8000
    }

    # All other routes — require Google OAuth via forward_auth
    handle {
        forward_auth oauth2-proxy:4180 {
            uri /oauth2/auth
            header_up X-Real-IP {remote_host}
            copy_headers X-Auth-Request-User X-Auth-Request-Email

            @error status 401
            handle_response @error {
                redir * /oauth2/sign_in?rd={scheme}://{host}{uri}
            }
        }

        # API routes (after auth check passed)
        handle /auth/* {
            reverse_proxy api:8000
        }
        handle /admin/* {
            reverse_proxy api:8000
        }
        handle /history/* {
            reverse_proxy api:8000
        }

        # Frontend (everything else, after auth check passed)
        handle {
            reverse_proxy frontend:8001
        }
    }

    log {
        output stdout
        format json
    }
}
